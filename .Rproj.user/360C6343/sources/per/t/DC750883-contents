---
title: "Cheese  Visualisaton"
subtitle: "Assignment 4"
author: "Anna Akhlamova"
format: 
  html: default
  docx: default
  typst: default
editor: visual
---

```{=html}
<style>
  body { background-color: lightyellow; }
</style>
```

```{r}
#| label: setup
#| include: false

library(pacman)

p_load(
  tidyverse,
  ggplot2,
  maps,
  RColorBrewer,
  plotly,
  ggthemes,
  stringr,
  countrycode,
  scales
)
```

```{r}
#| include: false
cheese <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/main/data/2024/2024-06-04/cheeses.csv')
cheese <- cheese |> select(-url)
```

```{r}
#| include: false
cheese <- cheese |>
  mutate(
    fat_num = as.numeric(str_extract(fat_content, "\\d+")),
    calcium_grams = as.numeric(str_extract(calcium_content, "\\d+"))/1000,
    fat_to_calcium_ratio = fat_num / calcium_grams ,
    fat_status = ifelse(fat_num > 40, "High fat", "Low fat"), .after = fat_content)
```

Using the cheese dataset, I will visualise and highlight the main insights.<br> The overall structure of the dataset is presented below.

```{r}
#| echo: false
glimpse(cheese)
```

```{r}
#| include: false
cheese_clean <- cheese %>% drop_na(family, fat_num)
```

## Dependency between cheese content and cheese family

Some families, such as **Caciotta** or **Havarti**, do not display a complete boxplot. This is due to the limited number of observations available for these categories.<br> We also see **Mozarella** and **Camembert**, which have quite small boxplot, so it has not have big variation in data. Their fat content is around 25-30% and 30-40% accordingly.<br> **Brie** and **Blue** show big variation in data, so we can’t generally categorize them as low-fat or fatty.

```{r}
#| code-fold: true
ggplot(cheese_clean, aes(x = family, y = fat_num)) +
  geom_boxplot(width = 0.3) +
  geom_jitter(alpha = 0.6, width=0.2) +
  labs( title = "Fat content distribution by cheese type" ,x = "Type of cheese", y = "Fat content (%)", color = "fat") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(
    panel.background = element_rect(fill = "lightblue"),
    plot.background = element_rect(fill = "lightyellow")
  )


```

## Milk for cheese preferences by continent

The graph clearly shows that, on each continent, the majority of cheese is made from **cow** milk. <br> However, we can also see that **goat** and **sheep** are produced at about half the amount of cow milk cheese.<br><br> A little remark about the code: the first chunk is for data preparation, where we might also see a warning because not every country is present in the dataset.<br> The other chunk is used for creating the graph.

```{r}
#| code-fold: true
milk_continent_summary <- cheese |> 
  filter(!is.na(milk), !is.na(country)) |> 
  mutate(milk_list = str_split(milk, ",\\s*")) |> 
  unnest(milk_list) |> 
  mutate(
    milk_general = case_when(
      str_detect(milk_list, "cow") ~ "cow",
      str_detect(milk_list, "goat") ~ "goat",
      str_detect(milk_list, "sheep") ~ "sheep",
      str_detect(milk_list, "buffalo") ~ "buffalo",
      TRUE ~ "other"
    ),
    continent = countrycode(country, "country.name", "continent")
  ) |> 
  filter(!is.na(continent), continent != "Africa") |> 
  group_by(continent, milk_general) |> 
  summarise(n_cheeses = n_distinct(cheese), .groups = "drop")

ggplot(milk_continent_summary, aes(x = reorder(milk_general, -n_cheeses), y = n_cheeses, fill = continent)) +
  geom_col(position = "dodge") +
  labs(
    title = "Cheeses by milk type and continent",
    x = "Milk type",
    y = "Number of cheeses",
    fill = "Continent"
  ) +
   scale_fill_manual(values=c("steelblue3","sienna1","lightgoldenrod1","darkseagreen1")) +
   theme( 
    panel.background = element_rect(fill = "lightblue"),
    plot.background = element_rect(fill = "lightyellow"),
    legend.background = element_rect(fill = "lightyellow"))



```

## Proportion of milk types in cheese across continents

This graph is similar to the previous one, but now it shows the proportion of cheese production by milk type across continents.<br> It is clear that Oceania and the Americas do not have any other types of milk in our dataset, by “other,” I mean vegetarian alternatives or less common types like moose milk.

```{r}
#| code-fold: true
milk_continent_prop <- cheese |> 
  filter(!is.na(milk), !is.na(country)) |> 
  mutate(milk_list = str_split(milk, ",\\s*")) |> 
  unnest(milk_list) |> 
  mutate(
    milk_general = case_when(
      str_detect(milk_list, "cow") ~ "cow",
      str_detect(milk_list, "goat") ~ "goat",
      str_detect(milk_list, "sheep") ~ "sheep",
      str_detect(milk_list, "buffalo") ~ "buffalo",
      TRUE ~ "other"
    ),
    continent = countrycode(country, "country.name", "continent"),
  ) |> 
  filter(!is.na(continent), continent != "Africa") |> 
  group_by(continent, milk_general) |> 
  summarise(n_cheeses = n_distinct(cheese), .groups = "drop") |> 
  mutate(milk_general = fct_reorder(milk_general, -n_cheeses)) 


ggplot(milk_continent_prop, aes(x = continent, y = n_cheeses, fill = milk_general)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_y_continuous(labels = percent) +
  labs(
    title = "Proportion of cheese types by milk across continents",
    x = "Continent",
    y = "Proportion of Cheeses",
    fill = "Milk Type"
  ) +
  scale_fill_manual(values = c("cow" = "#FFD700", "goat" = "ivory", "sheep" = "lightyellow2", "buffalo" = "burlywood4","other" = "gray58" 
  )) +
  theme( 
    panel.background = element_rect(fill = "lightblue"),
    plot.background = element_rect(fill = "lightyellow"),
    legend.background = element_rect(fill = "lightyellow"))


```

## Dominant cheese family by country

This is an interactive map where you can see the name of each country, the total number of cheeses, and, of course, the dominant cheese family. In some cases, the family of certain cheeses is unknown, so a “no-family” label may appear.

```{r}
#| code-fold: true

country_fix <- c(
  "United States" = "USA",
  "United States of America" = "USA",
  "United Kingdom" = "UK",
  "England, Great Britain, United Kingdom" = "UK",
  "England" = "UK",
  "Great Britain" = "UK",
  "Scotland" = "UK",
  "Wales" = "UK"
)

cheese_country <- cheese |> 
  filter(!is.na(country), !is.na(cheese)) |> 
  separate_rows(country, sep = ",\\s*") |> 
  mutate(country = recode(country, !!!country_fix)) |> 
  group_by(country) |> 
  summarise(
    total_cheeses = n_distinct(cheese),
    top_family = coalesce(names(sort(table(family), decreasing = TRUE))[1], "No family"),
    .groups = "drop"
  )



world_map <- map_data("world")

world_data <- world_map |> 
  left_join(cheese_country, by = c("region" = "country"))


p <- ggplot(world_data, aes(
    x = long, y = lat, group = group,
    fill = top_family,
    text = paste0("Country: ", region,
                  "<br>Cheeses: ", total_cheeses,
                  "<br>Top family: ", top_family))
  ) +
  geom_polygon(color = "black") +   
  coord_fixed(1.3) +
  theme_minimal() +
  labs(fill = "Dominant cheese family",
       title = "Dominant cheese family by country") +
   scale_fill_manual(values=c("lavender","lightgoldenrod1", "tan1", "burlywood", "navajowhite", "chocolate3", "cornsilk", "darkgoldenrod2", "gold1" , "khaki1"), na.value="gray75") +
  theme(panel.grid = element_blank(),
        panel.background = element_rect(fill = "lightblue"),
        plot.background = element_rect(fill = "lightyellow"),
    legend.background = element_rect(fill = "lightyellow"))


ggplotly(p, tooltip = "text")

```

Additionally, we can take a closer look at cheese dominance in Europe.

```{r}
#| code-fold: true
world_data_europe <- world_map |> 
  filter(lat > 35, lat < 72, long > -25, long < 45) |> 
  left_join(cheese_country, by = c("region" = "country"))

p_europe <- ggplot(world_data_europe, aes(
    x = long, y = lat, group = group,
    fill = top_family,
    text = paste0("Country: ", region,
                  "<br>Cheeses: ", total_cheeses,
                  "<br>Top family: ", top_family))
  ) +
  geom_polygon(color = "black") +
  coord_fixed(1.3) +
  theme_minimal() +
  labs(fill = "Dominant cheese family",
       title = "Dominant cheese family in Europe") +
  scale_fill_manual(values=c("lavender","lightgoldenrod1", "tan1", "burlywood", "navajowhite", "chocolate3", "cornsilk", "darkgoldenrod2", "gold1" , "khaki1"), na.value="gray75") +
  theme(panel.grid = element_blank(),
        panel.background = element_rect(fill = "lightblue"),
        plot.background = element_rect(fill = "lightyellow"),
    legend.background = element_rect(fill = "lightyellow"))

ggplotly(p_europe, tooltip = "text")

```
